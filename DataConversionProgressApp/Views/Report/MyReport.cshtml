@model List<TickedItem>

@{
    TimeZoneInfo jamaicaZone;
    try
    {
        jamaicaZone = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");
    }
    catch
    {
        jamaicaZone = TimeZoneInfo.Local; // fallback to server time zone
    }
}

<!-- Activity Log Section -->
<div class="section-box">
    <h2 class="text-primary">
        <i class="bi bi-journal-text"></i> Activity Log
    </h2>
    <hr class="my-4" />
    <small id="scrollHint" class="text-muted d-none">Scroll to view full history</small>

    @if (!Model.Any())
    {
        <p>No ticked items found yet. Start tracking your progress!</p>
    }
    else
    {
        

        <div id="activityScrollBox" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; padding: 0;">
            <table class="table table-sm table-bordered log-table mb-0" style="margin-bottom: 0;">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                    <tr>
                        <th>Date</th>
                        <th>Task</th>
                        <th>Date & Time</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model
                   .GroupBy(i => new { i.Date, Task = (i.TaskName ?? "").Replace(" (Removed)", "") })
                   .Select(g => g.OrderByDescending(i => i.Timestamp).First())
                   .Where(i => !((i.TaskName ?? "").Contains("(Removed)")))
                   )
                    {
                        var localTime = item.Timestamp.Kind == DateTimeKind.Utc
                        ? TimeZoneInfo.ConvertTimeFromUtc(item.Timestamp, jamaicaZone)
                        : item.Timestamp;

                        <tr>
                            <td>@item.Date.ToString("MMM dd, yyyy")</td>
                            <td title="Ticked by @item.Username">@item.TaskName</td>
                            <td>@localTime.ToString("MMM dd, yyyy h:mm tt")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>


    }
</div>

<!-- Undo History Section -->
@if (ViewBag.RemovedTicks != null && ((List<TickedItem>)ViewBag.RemovedTicks).Any())
{
    <div class="section-box">
        <h2 class="text-danger mt-2">
            <i class="bi bi-x-circle"></i> Undo History
        </h2>
        <hr class="my-2" />
        <small id="undoScrollHint" class="text-muted d-none">Scroll to view removed entries</small>


        <div id="undoScrollBox" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; padding: 0;">
            <table class="table table-sm table-bordered log-table mb-0">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 2;">
                    <tr>
                        <th>Date</th>
                        <th>Task</th>
                        <th>Date & Time</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in (List<TickedItem>)ViewBag.RemovedTicks)
                    {
                        var localTime = item.Timestamp.Kind == DateTimeKind.Utc
                        ? TimeZoneInfo.ConvertTimeFromUtc(item.Timestamp, jamaicaZone)
                        : item.Timestamp;

                        <tr>
                            <td>@item.Date.ToString("MMM dd, yyyy")</td>
                            <td title="Removed by @item.Username">@item.TaskName</td>
                            <td>@localTime.ToString("MMM dd, yyyy h:mm tt")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>


    </div>
}
<script>
    window.addEventListener('DOMContentLoaded', function () {
        // Activity Log scroll hint
        var activityScrollBox = document.getElementById('activityScrollBox');
        var activityHint = document.getElementById('scrollHint');
        if (activityScrollBox.scrollHeight > activityScrollBox.clientHeight) {
            activityHint.classList.remove('d-none');
        }

        // Undo History scroll hint
        var undoScrollBox = document.getElementById('undoScrollBox');
        var undoHint = document.getElementById('undoScrollHint');
        if (undoScrollBox.scrollHeight > undoScrollBox.clientHeight) {
            undoHint.classList.remove('d-none');
        }
    });
</script>

